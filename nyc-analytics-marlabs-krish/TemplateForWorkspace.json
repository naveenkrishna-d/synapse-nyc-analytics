{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"workspaceName": {
			"type": "string",
			"metadata": "Workspace name",
			"defaultValue": "nyc-analytics-marlabs-krish"
		},
		"nyc-analytics-marlabs-krish-WorkspaceDefaultSqlServer_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'nyc-analytics-marlabs-krish-WorkspaceDefaultSqlServer'",
			"defaultValue": "Integrated Security=False;Encrypt=True;Connection Timeout=30;Data Source=tcp:nyc-analytics-marlabs-krish.sql.azuresynapse.net,1433;Initial Catalog=@{linkedService().DBName}"
		},
		"nyc-analytics-marlabs-krish-WorkspaceDefaultStorage_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://marlabsnycanalyticsdl.dfs.core.windows.net"
		}
	},
	"variables": {
		"workspaceId": "[concat('Microsoft.Synapse/workspaces/', parameters('workspaceName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('workspaceName'), '/nyc-analytics-marlabs-krish-WorkspaceDefaultSqlServer')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"parameters": {
					"DBName": {
						"type": "String"
					}
				},
				"annotations": [],
				"type": "AzureSqlDW",
				"typeProperties": {
					"connectionString": "[parameters('nyc-analytics-marlabs-krish-WorkspaceDefaultSqlServer_connectionString')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/nyc-analytics-marlabs-krish-WorkspaceDefaultStorage')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('nyc-analytics-marlabs-krish-WorkspaceDefaultStorage_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/AutoResolveIntegrationRuntime')]",
			"type": "Microsoft.Synapse/workspaces/integrationRuntimes",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "Managed",
				"typeProperties": {
					"computeProperties": {
						"location": "AutoResolve",
						"dataFlowProperties": {
							"computeType": "General",
							"coreCount": 8,
							"timeToLive": 0
						}
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/WorkspaceSystemIdentity')]",
			"type": "Microsoft.Synapse/workspaces/credentials",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "ManagedIdentity",
				"typeProperties": {}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/1_expore_taxi_data')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "DEMOS"
				},
				"content": {
					"query": "-- SELECT * From sys.dm_external_data_processed;\n-- SELECT * from sys.configurations where name like 'Data Pro%';\n\n-- sp_set_data_processed_limit\n-- @type=N'monthly',\n-- @limit_tb=4;\n\n-- SELECT TOP 100 * \n-- FROM \n--     OPENROWSET(\n--         BULK 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/taxi_zone.csv',\n--         FORMAT='CSV',\n--         PARSER_VERSION='2.0',\n--         HEADER_ROW = TRUE,\n--         FIELDTERMINATOR=',',\n--         ROWTERMINATOR='\\n'\n-- )AS [result]\n\n\n-- EXEC sp_describe_first_result_set N'SELECT TOP 100 * FROM\n--     OPENROWSET(\n--         BULK ''abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/taxi_zone.csv'',\n--         FORMAT = ''CSV'',\n--         PARSER_VERSION = ''2.0'',\n--         HEADER_ROW = TRUE\n--     ) WITH (\n--     LocationID SMALLINT,\n--     Borough VARCHAR(15),\n--     Zone VARCHAR(50),\n--     service_zone VARCHAR(15)\n-- ) AS [result]'\n\n-- SELECT \n-- MAX(LEN(LocationID)) as len_LocationID,\n-- MAX(LEN(Borough)) as len_Borough,\n-- MAX(LEN(Zone)) as len_Zone,\n-- MAX(LEN(service_zone)) as len_service_zone\n-- FROM \n--     OPENROWSET(\n--         BULK 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/taxi_zone.csv',\n--         FORMAT='CSV',\n--         PARSER_VERSION='2.0',\n--         HEADER_ROW = TRUE,\n--         FIELDTERMINATOR=',',\n--         ROWTERMINATOR='\\n'\n-- )AS [result]\n\n-- SELECT TOP 100 *\n-- FROM \n--     OPENROWSET(\n--         BULK 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/taxi_zone.csv',\n--         FORMAT='CSV',\n--         PARSER_VERSION='2.0',\n--         HEADER_ROW = TRUE\n-- ) WITH (\n--     LocationID SMALLINT,\n--     Borough NVARCHAR(15),\n--     Zone NVARCHAR(50),\n--     service_zone VARCHAR(15)\n-- )\n-- AS [result]\n\n-- Explicitly change the collation\n\n-- SELECT name,collation_name from sys.databases;\n\n-- SELECT TOP 100 *\n-- FROM \n--     OPENROWSET(\n--         BULK 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/taxi_zone.csv',\n--         FORMAT='CSV',\n--         PARSER_VERSION='2.0',\n--         HEADER_ROW = TRUE\n-- ) WITH (\n--     LocationID SMALLINT ,\n--     Borough NVARCHAR(15),\n--     Zone NVARCHAR(50),\n--     service_zone VARCHAR(15) COLLATE Latin1_General_100_CI_AI_SC_UTF8\n-- )\n-- AS [result]\n\n\n-- CREATE DATABASE nyc_taxi_discovery;\n-- USE nyc_taxi_discovery;\n\n-- SELECT name,collation_name from sys.databases;\n\n-- ALTER DATABASE nyc_taxi_discovery COLLATE Latin1_General_100_CI_AI_SC_UTF8;\n\n--Query Subset of data\n\n\n\nSELECT TOP 100 *\nFROM \n    OPENROWSET(\n        BULK 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/taxi_zone_without_header.csv',\n        FORMAT='CSV',\n        PARSER_VERSION='2.0'\n) WITH ( --numbers here are column ordinal\n    Borough NVARCHAR(15) 2,\n    service_zone VARCHAR(15) 4\n)\nAS [result]\n\n--fix column names\n\nSELECT TOP 100 *\nFROM \n    OPENROWSET(\n        BULK 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/taxi_zone.csv',\n        FORMAT='CSV',\n        PARSER_VERSION='2.0',\n        FIRSTROW=2\n        --HEADER_ROW = TRUE\n) WITH (\n    location_id SMALLINT 1 ,\n    borough NVARCHAR(15) 2,\n    zone NVARCHAR(50) 3,\n    service_zone VARCHAR(15) 4\n)\nAS [result]\n\n-- create external data source\n\nCREATE EXTERNAL DATA SOURCE nyc_taxi_data\nWITH(\n    LOCATION = 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/'\n)\n\nCREATE EXTERNAL DATA SOURCE nyc_taxi_data_raw\nWITH(\n    LOCATION = 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/raw'\n)\n\n\n--DROP EXTERNAL DATA SOURCE nyc_taxi_data1\n\nSELECT TOP 100 *\nFROM \n    OPENROWSET(\n        BULK 'taxi_zone.csv',\n        DATA_SOURCE= 'nyc_taxi_data',\n        FORMAT='CSV',\n        PARSER_VERSION='2.0',\n        FIRSTROW=2\n        --HEADER_ROW = TRUE\n) WITH (\n    location_id SMALLINT 1 ,\n    borough NVARCHAR(15) 2,\n    zone NVARCHAR(50) 3,\n    service_zone VARCHAR(15) 4\n)\nAS [result]\n\nSELECT name,location from sys.external_data_sources;\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/2_explore_vendor')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "DEMOS"
				},
				"content": {
					"query": "SELECT *\nFROM\n    OPENROWSET(\n        BULK 'trip_type.tsv',\n        DATA_SOURCE= 'nyc_taxi_data',\n        FORMAT='CSV',\n        PARSER_VERSION='2.0',\n        HEADER_ROW = TRUE,\n        FIELDTERMINATOR ='\\t'\n    )AS [result]",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/3_explore_payment_type')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "DEMOS"
				},
				"content": {
					"query": "SELECT  JSON_VALUE(jsonDoc, '$.payment_type') payment_type,\n        JSON_VALUE(jsonDoc, '$.payment_type_desc') payment_type_desc\nFROM\n    OPENROWSET(\n        BULK 'payment_type.json',\n        DATA_SOURCE= 'nyc_taxi_data',\n        FORMAT='CSV',\n        PARSER_VERSION='1.0',\n        HEADER_ROW = TRUE,\n        FIELDTERMINATOR ='0x0b',\n        ROWTERMINATOR='0x0a',\n        FIELDQUOTE='0x0b'\n    )with (jsonDoc nvarchar(max)) \n    AS payment_type\n\n\n-- json array\n\nSELECT  CAST(JSON_VALUE(jsonDoc, '$.payment_type')as SMALLINT) payment_type,\n        CAST(JSON_VALUE(jsonDoc, '$.payment_type_desc[0].value') as VARCHAR(15)) payment_type_desc0,\n        CAST(JSON_VALUE(jsonDoc, '$.payment_type_desc[1].value') as VARCHAR(15)) payment_type_desc1\nFROM\n    OPENROWSET(\n        BULK 'payment_type_array.json',\n        DATA_SOURCE= 'nyc_taxi_data',\n        FORMAT='CSV',\n        PARSER_VERSION='1.0',\n        HEADER_ROW = TRUE,\n        FIELDTERMINATOR ='0x0b',\n        ROWTERMINATOR='0x0a',\n        FIELDQUOTE='0x0b'\n    )with (jsonDoc nvarchar(max)) \n    AS payment_type\n\n-----------\n\nSELECT  *\nFROM\n    OPENROWSET(\n        BULK 'payment_type_array.json',\n        DATA_SOURCE= 'nyc_taxi_data',\n        FORMAT='CSV',\n        PARSER_VERSION='1.0',\n        HEADER_ROW = TRUE,\n        FIELDTERMINATOR ='0x0b',\n        ROWTERMINATOR='0x0a',\n        FIELDQUOTE='0x0b'\n    )with (jsonDoc nvarchar(max)) \n    AS payment_type\n    CROSS APPLY OPENJSON(jsonDoc)\n    WITH\n    (\n        payment_type SMALLINT,\n        payment_type_desc NVARCHAR(MAX) as JSON\n    )\n    CROSS APPLY OPENJSON(payment_type_desc) \n    with (\n        sub_type SMALLINT,\n        payment_type_desc_value NVARCHAR(20) '$.value'\n    );\n\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/4_expore_rate_code')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "DEMOS"
				},
				"content": {
					"query": "-- SELECT  *\n-- FROM\n--     OPENROWSET(\n--         BULK 'rate_code.json',\n--         DATA_SOURCE= 'nyc_taxi_data',\n--         FORMAT='CSV',\n--         PARSER_VERSION='1.0',\n--         HEADER_ROW = TRUE,\n--         FIELDTERMINATOR ='0x0b',\n--         ROWTERMINATOR='0x0a',\n--         FIELDQUOTE='0x0b'\n--     )WITH(\n--         jsonDoc NVARCHAR(MAX)\n--     )AS rate_code\n-- CROSS APPLY OPENJSON(jsonDoc) \n-- WITH (\n--     rate_code_id TINYINT ,\n--     rate_code NVARCHAR(20)\n-- );\n\n-- WITH jsonData AS (\n--     SELECT BulkColumn AS jsonDoc\n--     FROM OPENROWSET(\n--         BULK 'rate_code.json',\n--         DATA_SOURCE = 'nyc_taxi_data',\n--         FORMAT='CSV',\n--         PARSER_VERSION='1.0',\n--         HEADER_ROW = TRUE,\n--         FIELDTERMINATOR ='0x0b',\n--         ROWTERMINATOR='0x0a',\n--         FIELDQUOTE='0x0b'\n--     ) AS jsonFile\n-- )\n\n-- -- Parse the JSON data\n-- SELECT \n--     JSON_VALUE(value, '$.rate_code_id') AS rate_code_id,\n--     JSON_VALUE(value, '$.rate_code') AS rate_code\n-- FROM jsonData\n-- CROSS APPLY OPENJSON(jsonDoc) AS rate",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/5_explore_trip_data_file')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "DEMOS"
				},
				"content": {
					"query": "SELECT\nresult.filename() as file_name,\nresult.filepath(1) as year,\nresult.filepath(2) as month,\nresult.filepath(3) as files,\nCOUNT(1) AS record_count\nFROM OPENROWSET(\n    BULK '/trip_data_green_csv/year=*/month=*/*.csv',\n        DATA_SOURCE = 'nyc_taxi_data_raw',\n        FORMAT = 'CSV',\n        PARSER_VERSION = '2.0',\n        HEADER_ROW = TRUE,\n        FIELDTERMINATOR = ','\n)AS [result]\nWHERE [result].filename() IN ('green_tripdata_2020-01.csv','green_tripdata_2020-02.csv')\nGROUP BY [result].filename(), result.filepath(1), result.filepath(2), result.filepath(3)\nORDER BY [result].filename(), result.filepath(1), result.filepath(2), result.filepath(3)\n\n--abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/raw",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/6_explore_parquet')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "-- This is auto-generated code\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'https://marlabsnycanalyticsdl.dfs.core.windows.net/nyc-taxi-data/raw/trip_data_green_parquet/year=2020/month=01/part-00000-tid-6133789922049958496-2e489315-890a-4453-ae93-a104be9a6f06-106-1-c000.snappy.parquet',\n        FORMAT = 'PARQUET'\n    ) AS [result]\n\n---identify the inserted data types\nEXEC sp_describe_first_result_set N'\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK ''https://marlabsnycanalyticsdl.dfs.core.windows.net/nyc-taxi-data/raw/trip_data_green_parquet/year=2020/month=01/part-00000-tid-6133789922049958496-2e489315-890a-4453-ae93-a104be9a6f06-106-1-c000.snappy.parquet'',\n        FORMAT = ''PARQUET''\n    ) AS [result]'\n\n-- define cols and data types\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK '/trip_data_green_parquet/year=2020/month=01/part-00000-tid-6133789922049958496-2e489315-890a-4453-ae93-a104be9a6f06-106-1-c000.snappy.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE='nyc_taxi_data_raw'\n    )\n    WITH (\n      VendorID INT,\n        lpep_pickup_datetime datetime2(7),\n        lpep_dropoff_datetime datetime2(7),\n        store_and_fwd_flag CHAR(1),\n        RatecodeID INT,\n        PULocationID INT,\n        DOLocationID INT,\n        passenger_count INT,\n        trip_distance FLOAT,\n        fare_amount FLOAT,\n        extra FLOAT,\n        mta_tax FLOAT,\n        tip_amount FLOAT,\n        tolls_amount FLOAT,\n        ehail_fee INT,\n        improvement_surcharge FLOAT,\n        total_amount FLOAT,\n        payment_type INT,\n        trip_type INT,\n        congestion_surcharge FLOAT\n  ) \n     AS [result]\n\n\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK '/trip_data_green_parquet/year=2020/month=01/',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE='nyc_taxi_data_raw'\n    )\n    WITH (\n      VendorID INT,\n        tip_amount FLOAT,\n        trip_type INT\n  ) \n     AS [result]\n\n/*\nAssignment\n----------\n1) query from folders using wildcard characters\n2) use filename function\n3) query from subfolders\n4) use filepath function to select only from certain partitions\n*/\n\n\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK '/trip_data_green_parquet/year=2020/month=01/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE='nyc_taxi_data_raw'\n    )\n     AS [result]\n\nSELECT\n    result.filename() AS file_name, COUNT(*)\nFROM\n    OPENROWSET(\n        BULK '/trip_data_green_parquet/year=2020/month=01/*.parquet',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE='nyc_taxi_data_raw'\n    )\n     AS [result]\nGROUP BY result.filename();\n\n--Query from sub folders\nSELECT\n    result.filename() AS file_name, COUNT(*)\nFROM\n    OPENROWSET(\n        BULK '/trip_data_green_parquet/**',\n        FORMAT = 'PARQUET',\n        DATA_SOURCE='nyc_taxi_data_raw'\n    )\n     AS [result]\nGROUP BY result.filename();\n\nSELECT trip_data.filepath(1) AS year,\n       trip_data.filepath(2) AS month,\n       COUNT(1) AS record_count\n  FROM OPENROWSET (\n      BULK 'trip_data_green_parquet/year=*/month=*/*.parquet',\n      DATA_SOURCE = 'nyc_taxi_data_raw',\n      FORMAT = 'PARQUET'\n  ) AS trip_data\n WHERE trip_data.filepath(1) = '2020'\n   AND trip_data.filepath(2) IN ('06', '07', '08')\nGROUP BY trip_data.filepath(1), trip_data.filepath(2)\nORDER BY trip_data.filepath(1), trip_data.filepath(2);\n\n--nyc_taxi_data_raw abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net/raw\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/7_explore_delta')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "use nyc_taxi_discovery;\n-- This is auto-generated code\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'trip_data_green_delta/',\n        DATA_SOURCE = 'nyc_taxi_data_raw',\n        FORMAT = 'DELTA'\n    ) AS [result]\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/8_check_duplicates')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "SELECT location_id, COUNT(*) \nFROM \n    OPENROWSET(\n        BULK 'https://marlabsnycanalyticsdl.dfs.core.windows.net/nyc-taxi-data/raw/taxi_zone.csv',\n        FORMAT='CSV',\n        PARSER_VERSION='2.0',\n        HEADER_ROW = TRUE,\n        FIELDTERMINATOR=',',\n        ROWTERMINATOR='\\n'\n)WITH (\n    location_id SMALLINT 1,\n    borough VARCHAR(15) 2,\n    zone VARCHAR(50) 3,\n    service_zone VARCHAR(15) 4\n)\n AS [result]\n GROUP BY location_id\n HAVING COUNT(*)>1;\n\n--------------\nSELECT \n    MIN(total_amount) as min_total_amount,\n    MAX(total_amount) as max_total_amount,\n    AVG(total_amount) as avg_total_amount,\n    COUNT(1) as total_number_of_records,\n    COUNT(total_amount) as non_null_total_number_of_records\nFROM \n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/',\n        FORMAT='PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n)\n AS [result]\n\n-----\n\nSELECT \n    TOP 100 *\nFROM \n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/',\n        FORMAT='PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n)\n AS [result]\n ORDER BY total_amount\n\n-------\n\nSELECT \n    payment_type, COUNT(1) AS count\nFROM \n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/',\n        FORMAT='PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n)\n AS [result]\n GROUP BY payment_type\n ORDER BY payment_type\n\n\n----\nSELECT \n    payment_type, COUNT(1) AS count\nFROM \n    OPENROWSET(\n        BULK 'trip_data_green_parquet/year=2020/month=01/',\n        FORMAT='PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n)\n AS [result]\n GROUP BY payment_type\n ORDER BY payment_type\n\n\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/9_payment_type_join')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "SELECT \n    TOP 100\n    result.VendorID,\n    result.lpep_pickup_datetime,\n    result.lpep_dropoff_datetime,\n    result.store_and_fwd_flag,\n    result.RatecodeID,\n    result.PULocationID,\n    result.DOLocationID,\n    result.passenger_count,\n    result.trip_distance,\n    result.fare_amount,\n    result.extra,\n    result.mta_tax,\n    result.tip_amount,\n    result.tolls_amount,\n    result.ehail_fee,\n    result.improvement_surcharge,\n    result.total_amount,\n    payment_type.payment_type_desc AS payment_type_desc,\n    result.trip_type,\n    result.congestion_surcharge\nFROM \n    OPENROWSET(\n        BULK '/trip_data_green_parquet/year=2020/month=01/',\n        FORMAT='PARQUET',\n        DATA_SOURCE = 'nyc_taxi_data_raw'\n    ) AS result\nJOIN\n    OPENROWSET(\n        BULK 'raw/payment_type.json',\n        DATA_SOURCE = 'nyc_taxi_data',\n        FORMAT='CSV',\n        PARSER_VERSION='1.0',\n        FIELDTERMINATOR = '0x0A', -- Line terminator\n        FIELDQUOTE = '0x22', -- Double quote\n        ROWTERMINATOR = '0x0A' -- Line terminator\n        \n    ) WITH (\n        payment_type INT,\n        payment_type_desc NVARCHAR(50)\n    ) AS payment_type\nON result.payment_type = payment_type.payment_type\n\nSELECT * \nFROM\nOPENROWSET(\n        BULK 'raw/payment_type.json',\n        DATA_SOURCE = 'nyc_taxi_data',\n        FORMAT='CSV',\n        PARSER_VERSION='1.0',\n        --FIELDTERMINATOR = '0x0A', -- Line terminator\n        --FIELDQUOTE = '0x22', -- Double quote\n        --ROWTERMINATOR = '0x0A' -- Line terminator\n        FIELDTERMINATOR ='0x0b',\n        ROWTERMINATOR='0x0a',\n        FIELDQUOTE='0x0b'\n    ) WITH (\n        payment_type INT,\n        payment_type_desc NVARCHAR(50)\n    ) AS payment_type\n\nSELECT  JSON_VALUE(jsonDoc, '$.payment_type') payment_type,\n        JSON_VALUE(jsonDoc, '$.payment_type_desc') payment_type_desc\nFROM\n    OPENROWSET(\n        BULK '/raw/payment_type.json',\n        DATA_SOURCE= 'nyc_taxi_data',\n        FORMAT='CSV',\n        PARSER_VERSION='1.0',\n        HEADER_ROW = TRUE,\n        FIELDTERMINATOR ='0x0b',\n        ROWTERMINATOR='0x0a',\n        FIELDQUOTE='0x0b'\n    )with (jsonDoc nvarchar(max)) \n    AS payment_type\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Create_datasource')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "ldw"
				},
				"content": {
					"query": "CREATE EXTERNAL DATA SOURCE nyc_taxi_src\nWITH\n  ( LOCATION = 'https://marlabsnycanalyticsdl.dfs.core.windows.net/nyc-taxi-data'  \n  );\n\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "ny_taxi_ldw",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Create_external_file_formate')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "ldw"
				},
				"content": {
					"query": "-- Create an external file format for DELIMITED (CSV/TSV) files.\nCREATE EXTERNAL FILE FORMAT csv_file_format1\nWITH (\n        FORMAT_TYPE = DELIMITEDTEXT, \n        FORMAT_OPTIONS ( \n            FIELD_TERMINATOR = ',',\n            STRING_DELIMITER = '\"',\n            FIRST_ROW = 2,\n            USE_TYPE_DEFAULT = FALSE,\n            ENCODING = 'UTF8',\n            PARSER_VERSION='2.0'\n     ));\n\n\n\n\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "ny_taxi_ldw",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/SQL script 1')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "-- This is auto-generated code\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK '/trip_data_green_csv/year=2020/month=01/green_tripdata_2020-01.csv',\n        FORMAT = 'CSV',\n        DATA_SOURCE='nyc_taxi_data_raw',\n        PARSER_VERSION = '2.0'\n    ) AS [result]\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "nyc_taxi_discovery",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/SQL script 2')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "ldw"
				},
				"content": {
					"query": "-- Create a new external table\nCREATE EXTERNAL TABLE  bronze.taxi_zone1\n    (\n        loacation_id SMALLINT,\n        borough VARCHAR(15),\n        zone VARCHAR(15),\n        service_zone VARCHAR(15)\n     )\n    WITH (\n        LOCATION = 'raw/taxi_zone.csv',\n        DATA_SOURCE = nyc_taxi_src,\n        FILE_FORMAT = csv_file_format1\n    );\n\n--DROP EXTERNAL TABLE bronze.taxi_zone\n\nSELECT TOP (100) *\n FROM bronze.taxi_zone1\n\n\nCREATE EXTERNAL TABLE bronze.taxi_zone\n    ( \n        location_id SMALLINT,\n        borough VARCHAR(15),\n        zone VARCHAR(50),\n        service_zone VARCHAR(15)\n     )\n    WITH (\n        LOCATION = 'raw/taxi_zone.csv',\n        DATA_SOURCE = nyc_taxi_src,\n        FILE_FORMAT = csv_file_format\n    );\n\n\nSELECT * FROM bronze.taxi_zone;\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "ny_taxi_ldw",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/SQL script 3')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "IF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'SynapseDelimitedTextFormat') \n\tCREATE EXTERNAL FILE FORMAT [SynapseDelimitedTextFormat] \n\tWITH ( FORMAT_TYPE = DELIMITEDTEXT ,\n\t       FORMAT_OPTIONS (\n\t\t\t FIELD_TERMINATOR = ',',\n\t\t\t USE_TYPE_DEFAULT = FALSE\n\t\t\t))\nGO\n\nIF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'nyc-taxi-data_marlabsnycanalyticsdl_dfs_core_windows_net') \n\tCREATE EXTERNAL DATA SOURCE [nyc-taxi-data_marlabsnycanalyticsdl_dfs_core_windows_net] \n\tWITH (\n\t\tLOCATION = 'abfss://nyc-taxi-data@marlabsnycanalyticsdl.dfs.core.windows.net' \n\t)\nGO\n\nCREATE EXTERNAL TABLE bronze.taxi_zone2 (\n\t[C1] nvarchar(4000),\n\t[C2] nvarchar(4000),\n\t[C3] nvarchar(4000),\n\t[C4] nvarchar(4000)\n\t)\n\tWITH (\n\tLOCATION = 'raw/taxi_zone.csv',\n\tDATA_SOURCE = [nyc-taxi-data_marlabsnycanalyticsdl_dfs_core_windows_net],\n\tFILE_FORMAT = [SynapseDelimitedTextFormat]\n\t)\nGO\n\n\nSELECT TOP 100 * FROM bronze.taxi_zone2\nGO",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "ny_taxi_ldw",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/SQL script 4')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "ldw"
				},
				"content": {
					"query": "\nUSE ny_taxi_ldw;\n\nCREATE EXTERNAL DATA SOURCE nyc_taxi_src1\nWITH\n  ( \n    LOCATION = 'https://marlabsnycanalyticsdl.dfs.core.windows.net/nyc-taxi-data' \n  );\n\nCREATE EXTERNAL FILE FORMAT csv_file_format2\nWITH (\n        FORMAT_TYPE = DELIMITEDTEXT,\n        FORMAT_OPTIONS ( \n\n             FIELD_TERMINATOR = ',',\n            STRING_DELIMITER = '\"',\n            FIRST_ROW = 2,\n            USE_TYPE_DEFAULT = FALSE, \n            ENCODING = 'UTF8',\n            PARSER_VERSION = '2.0'\n        ) \n    );\n\n-- Create a new external table\nCREATE EXTERNAL TABLE bronze.taxi_zone2\n    ( \n        location_id SMALLINT,\n        borough VARCHAR(15),\n        zone VARCHAR(50),\n        service_zone VARCHAR(15)\n     )\n    WITH (\n        LOCATION = 'raw/taxi_zone.csv',\n        DATA_SOURCE = nyc_taxi_src,\n        FILE_FORMAT = csv_file_format2\n    );\n\n\nSELECT * FROM bronze.taxi_zone2;\n\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "ny_taxi_ldw",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/database create')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"folder": {
					"name": "ldw"
				},
				"content": {
					"query": "CREATE DATABASE ny_taxi_ldw\nGO\n\nALTER DATABASE ny_taxi_ldw COLLATE Latin1_General_100_BIN2_UTF8\nGO\n\nUSE ny_taxi_ldw\nGO\n\nCREATE SCHEMA bronze\nGO\n\nCREATE SCHEMA silver\nGO\n\nCREATE SCHEMA gold\nGO",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "ny_taxi_ldw",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		}
	]
}